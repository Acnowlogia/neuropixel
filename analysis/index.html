



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Documentation for neuropixel-utils">
      
      
      
        <meta name="author" content="Daniel J. O'Shea">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.2.0">
    
    
      
        <title>Analysis of Kilosort Results - Neuropixel Utilities</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.572ca0f0.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#2196f3">
      
    
    
      <script src="../assets/javascripts/modernizr.8c900955.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="blue" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#analysis-of-kilosort-results" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Neuropixel Utilities" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Neuropixel Utilities
              </span>
              <span class="md-header-nav__topic">
                Analysis of Kilosort Results
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/djoshea/neuropixel-utils/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      djoshea/neuropixel-utils
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Neuropixel Utilities" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Neuropixel Utilities
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/djoshea/neuropixel-utils/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      djoshea/neuropixel-utils
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../imec_dataset/" title="Neuropixel.ImecDataset" class="md-nav__link">
      Neuropixel.ImecDataset
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../kilosort/" title="Running Kilosort" class="md-nav__link">
      Running Kilosort
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Analysis of Kilosort Results
      </label>
    
    <a href="./" title="Analysis of Kilosort Results" class="md-nav__link md-nav__link--active">
      Analysis of Kilosort Results
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#simple-statistics" title="Simple statistics" class="md-nav__link">
    Simple statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kilosortmetrics" title="KilosortMetrics" class="md-nav__link">
    KilosortMetrics
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plotting-drift-maps" title="Plotting drift maps" class="md-nav__link">
    Plotting drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-drift-maps" title="Plotting cluster drift maps" class="md-nav__link">
    Plotting cluster drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-centers-of-mass" title="Plotting cluster centers of mass" class="md-nav__link">
    Plotting cluster centers of mass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-electrical-images" title="Plotting electrical images" class="md-nav__link">
    Plotting electrical images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../waveforms/" title="Extracting Waveforms" class="md-nav__link">
      Extracting Waveforms
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../acknowledgements/" title="Acknowledgements and Support" class="md-nav__link">
      Acknowledgements and Support
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#simple-statistics" title="Simple statistics" class="md-nav__link">
    Simple statistics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kilosortmetrics" title="KilosortMetrics" class="md-nav__link">
    KilosortMetrics
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#plotting-drift-maps" title="Plotting drift maps" class="md-nav__link">
    Plotting drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-drift-maps" title="Plotting cluster drift maps" class="md-nav__link">
    Plotting cluster drift maps
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-cluster-centers-of-mass" title="Plotting cluster centers of mass" class="md-nav__link">
    Plotting cluster centers of mass
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#plotting-electrical-images" title="Plotting electrical images" class="md-nav__link">
    Plotting electrical images
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/djoshea/neuropixel-utils/edit/master/docs/analysis.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="analysis-of-kilosort-results">Analysis of Kilosort Results<a class="headerlink" href="#analysis-of-kilosort-results" title="Permanent link">&para;</a></h1>
<h2 id="simple-statistics">Simple statistics<a class="headerlink" href="#simple-statistics" title="Permanent link">&para;</a></h2>
<p>Simple statistics for a KilosortDataset can be computed / printed using:</p>
<div class="codehilite"><pre><span></span><span class="o">&gt;&gt;</span> <span class="n">stats</span> <span class="p">=</span> <span class="n">ks</span><span class="p">.</span><span class="n">computeBasicStats</span><span class="p">();</span>
<span class="o">&gt;&gt;</span> <span class="n">ks</span><span class="p">.</span><span class="n">printBasicStats</span><span class="p">();</span>
<span class="n">neuropixel_01</span><span class="p">:</span> <span class="mf">3747.1</span> <span class="nb">sec</span><span class="p">,</span> <span class="mi">8181228</span> <span class="p">(</span><span class="mi">6974070</span><span class="p">)</span> <span class="n">spikes</span><span class="p">,</span> <span class="mi">592</span> <span class="p">(</span><span class="mi">187</span><span class="p">)</span> <span class="n">clusters</span> <span class="p">(</span><span class="n">with</span> <span class="n">fr</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="n">Hz</span><span class="p">)</span>

<span class="o">&gt;&gt;</span> <span class="n">stats</span>
<span class="n">stats</span> <span class="p">=</span>

  <span class="n">struct</span> <span class="n">with</span> <span class="n">fields</span><span class="p">:</span>

          <span class="n">spike_clusters</span><span class="p">:</span> <span class="p">[</span><span class="mi">8181228</span>×<span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
             <span class="n">cluster_ids</span><span class="p">:</span> <span class="p">[</span><span class="mi">592</span>×<span class="mi">1</span> <span class="n">uint32</span><span class="p">]</span>
                  <span class="n">offset</span><span class="p">:</span> <span class="mi">0</span>
             <span class="n">sample_rate</span><span class="p">:</span> <span class="mi">30000</span>
             <span class="n">spike_times</span><span class="p">:</span> <span class="p">[</span><span class="mi">8181228</span>×<span class="mi">1</span> <span class="n">uint64</span><span class="p">]</span>
                 <span class="n">nSpikes</span><span class="p">:</span> <span class="mi">8181228</span>
               <span class="n">nClusters</span><span class="p">:</span> <span class="mi">592</span>
                    <span class="n">nSec</span><span class="p">:</span> <span class="mf">3.7471e+03</span>
                      <span class="n">fr</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span>×<span class="mi">591</span> <span class="n">double</span><span class="p">]</span>
                  <span class="n">thresh</span><span class="p">:</span> <span class="mi">3</span>
             <span class="n">clusterMask</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span>×<span class="mi">591</span> <span class="n">logical</span><span class="p">]</span>
    <span class="n">nClustersAboveThresh</span><span class="p">:</span> <span class="mi">187</span>
      <span class="n">nSpikesAboveThresh</span><span class="p">:</span> <span class="mi">6974070</span>
</pre></div>

<h2 id="kilosortmetrics">KilosortMetrics<a class="headerlink" href="#kilosortmetrics" title="Permanent link">&para;</a></h2>
<p>More computed statistics can be computed on demand by calling
<div class="codehilite"><pre><span></span><span class="n">metrics</span> <span class="p">=</span> <span class="n">ks</span><span class="p">.</span><span class="n">computeMetrics</span><span class="p">();</span>
</pre></div></p>
<p>which returns a <code class="codehilite">Neuropixel.KilosortMetrics</code> instance. This is a catch-all class for storing all the statistics we want to compute about the results of a Kilosort run. At the moment, most of these properties are related to localizing spikes / templates / clusters in spatial coordinates on the probe. The details of these computations borrow heavily from code written by Nick Steinmetz described on the <a href="https://github.com/cortex-lab/neuropixels/wiki/Other_analysis_methods">Neuropixels wiki</a>.</p>
<p>Many properties are computed for each cluster, for each template (as multiple templates may comprise each cluster), and for each individual spike.</p>
<ul>
<li>Spatial location properties end in <code class="codehilite">_centerOfMass</code>, and have x,y (and someday z) along the second dimension</li>
<li><code class="codehilite">depth</code> properties are shorthands for the <code class="codehilite">y</code> spatial dimension of <code class="codehilite">centerOfMass</code></li>
<li><code class="codehilite">waveform</code> properties store the template-derived waveform taken from the largest channel</li>
<li><code class="codehilite">best_channels</code> properties indicate which channels best capture the electrical image of a given template or cluster. * <code class="codehilite">amplitude</code> properties are already in uV</li>
<li><code class="codehilite">is_localized</code> properties indicate whether the electrical image is sufficiently well localized in space</li>
</ul>
<p>KilosortMetrics with properties:</p>
<div class="codehilite"><pre><span></span>                       ks: [1×1 Neuropixel.KiloSortDataset]
                  nSpikes: 8181228
          nChannelsSorted: 371
               nTemplates: 653
      nTemplateTimepoints: 82
                nClusters: 592
       nConcatenatedFiles: 1
   maxTemplatesPerCluster: 11
                       fs: 30000
               channelMap: [1×1 Neuropixel.ChannelMap]
              channel_ids: [nChannelsSorted × 1 uint32]
      concatenatedSamples: 112412208
       concatenatedStarts: 1
        concatenatedNames: &quot;neuropixel_01&quot;

             template_unw: [nTemplates × nTemplateTimepoints × nChannelsSorted single] % unwhitened templates in original data scale
          template_scaled: [nTemplates × nTemplateTimepoints × nChannelsSorted single] % unwhitened, scaled templates in uV

    template_centerOfMass: [nTemplates × 2 single]
    template_is_localized: [nTemplates × 1 logical]
        template_waveform: [nTemplates × nTemplateTimepoints single]
     template_waveform_ch: [nTemplates × 1 uint32]
       template_amplitude: [nTemplates × 1 single]
             template_ttp: [nTemplates × 1 single]
   template_best_channels: [nTemplates × nChannelsSorted uint32]

              spike_times: [nSpikes × 1 uint64]
          spike_amplitude: [nSpikes × 1 single]
       spike_centerOfMass: [nSpikes × 2 single] % x, y
          spike_templates: [nSpikes × 1 uint32]
           spike_clusters: [nSpikes × 1 uint32]
           spike_depth: [nSpikes × 1 single]
    spike_is_localized: [nSpikes × 1 logical]

              cluster_ids: [nClusters × 1 uint32]
cluster_template_mostUsed: [nClusters × 1 uint32]
    cluster_template_list: {nClusters × 1 cell}
cluster_template_useCount: [nClusters × nTemplates uint64]
    cluster_num_templates: [nClusters × 1 uint32]
    cluster_best_channels: [nClusters × nChannelsSorted uint32]
     cluster_centerOfMass: [nClusters × 2 single] % x, y
     cluster_is_localized: [nClusters × 1 logical]
         cluster_waveform: [nClusters × nTemplateTimepoints × maxTemplatesPerCluster single]
      cluster_waveform_ch: [nClusters × nClusters uint32]
        cluster_amplitude: [nClusters × 1 single]
              cluster_ttp: [nClusters × 1 single]
            cluster_depth: [nClusters × 1 single]
</pre></div>


<p>```
</p>
<h3 id="plotting-drift-maps">Plotting drift maps<a class="headerlink" href="#plotting-drift-maps" title="Permanent link">&para;</a></h3>
<p>A drift map plots the spatial depth of all spikes over time as individual dots, where the dot color darkness increases for large amplitude spikes, allowing the eye to follow bands of spikes over time. The code for generating this plot was largely copied from the <a href="https://github.com/cortex-lab/spikes">Cortex lab spikes repo</a> and modified to use the KilosortMetrics structure and add some additional metadata.

You can plot a standard driftmap using:
<code class="codehilite">matlabmetrics.plotDriftmap();</code></p>
<p><img alt="driftmap" src="../images/driftmap_standard.png" title="Cluster driftmap" /></p>
<p>Significant drift events are marked in red in the raster and shown as red ticks above. You can set the driftThreshold in µm for drift events as a parameter, as well as lower the threshold for spike amplitude quantile to include smaller spikes in the calculation:</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;driftThreshold&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;spikeAmpQuantile&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">);</span>
</pre></div>

<p><img alt="driftmap_sensitive" src="../images/driftmap_sensitive.png" title="Driftmap" /></p>
<p>If you have <a href="/kilosort/#segmenting-a-kilosort-dataset-into-trials">computed trial segmentation boundaries</a> stored in a <a href="/kilosort/#trialsegmentationinfo"><code class="codehilite">TrialSegmentationInfo</code></a> instance, you can pass them in to show the trial boundaries as blue ticks at the bottom.</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">);</span>
</pre></div>

<p><img alt="driftmap_tsi" src="../images/driftmap_tsi.png" title="Driftmap" /></p>
<p>As you can see, the vertical bands where spiking activity looks very different from other timepoints occur when no trials were present. Indeed, these were time periods where the task was paused and the subject was asleep. We can mask out these regions to better assess drift over the time periods we&rsquo;re most concerned with:</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;maskRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
</pre></div>

<p><img alt="driftmap_tsi_mask" src="../images/driftmap_tsi_mask.png" title="Driftmap" /></p>
<p>Or we can excise those regions of time for plotting purposes only, to simulate what would happen <a href="/imec_dataset/#excising-time-windows">if we excised those regions during pre-processing</a>. Locations where timepoints are spliced together are indicated using magenta lines.</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
</pre></div>

<p><img alt="driftmap_tsi_excise" src="../images/driftmap_tsi_excise.png" title="Driftmap" /></p>
<h3 id="plotting-cluster-drift-maps">Plotting cluster drift maps<a class="headerlink" href="#plotting-cluster-drift-maps" title="Permanent link">&para;</a></h3>
<p>The driftmaps can help the eye spot points where spikes shift in space, but they do not indicate where Kilosort may have split a cluster over time. <code class="codehilite">metrics.plotClusterDriftmap</code> is similar to <code class="codehilite">plotDriftmap</code> except that it colors each dot according to cluster id. For these plots, it is helpful to subselect a subset of cluster ids to keep the plots from being too dense. Cluster ids tend to be roughly in order along the probe because of Kilosort&rsquo;s algorithm, so be sure to sample uniformly over the cluster ids when subselecting.</p>
<div class="codehilite"><pre><span></span><span class="n">cluster_ids</span> <span class="p">=</span> <span class="n">metrics</span><span class="p">.</span><span class="n">cluster_ids</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">:</span><span class="n">metrics</span><span class="p">.</span><span class="n">nClusters</span><span class="p">);</span>
<span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="s">&#39;cluster_ids&#39;</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">);</span>
</pre></div>

<p><img alt="clustermap" src="../images/clustermap.png" title="Cluster driftmap" /></p>
<div class="admonition tip">
<p class="admonition-title">Hover over tool tips</p>
<p>For these plots, in newer versions of Matlab, you can hover over points in the plot to see a popup tooltip that will display information about the cluster to which that point belongs.</p>
</div>
<p>You can also tweak the colors of each cluster so that larger amplitude clusters appear brighter using <code class="codehilite">&#39;colorByAmp&#39;, true</code>.</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="s">&#39;cluster_ids&#39;</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">,</span> <span class="s">&#39;colorByAmp&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">);</span>
</pre></div>

<p><img alt="clustermap_colorByAmp" src="../images/clustermap_colorByAmp.png" title="Cluster driftmap" /></p>
<p>By default, larger clusters are plotted on top, but you can randomize the plotting order using <code class="codehilite">&#39;zShuffleClusters&#39;, true</code>. Instead of plotting each individual spike, you can plot a smoothed estimate of cluster depth by passing <code class="codehilite">&#39;showSmooth&#39;, true, &#39;showIndividual&#39;, false</code>:</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotDriftmap</span><span class="p">(</span><span class="s">&#39;tsi&#39;</span><span class="p">,</span> <span class="n">tsi</span><span class="p">,</span> <span class="s">&#39;exciseRegionsOutsideTrials&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="s">&#39;cluster_ids&#39;</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">,</span> <span class="c">...</span>
    <span class="s">&#39;showSmooth&#39;</span><span class="p">,</span> <span class="n">true</span><span class="p">,</span> <span class="s">&#39;showIndividual&#39;</span><span class="p">,</span> <span class="n">false</span><span class="p">,</span> <span class="s">&#39;smoothWidthSeconds&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">);</span>
</pre></div>

<p><img alt="clustermap_smooth" src="../images/clustermap_smooth.png" title="Cluster driftmap" /></p>
<h3 id="plotting-cluster-centers-of-mass">Plotting cluster centers of mass<a class="headerlink" href="#plotting-cluster-centers-of-mass" title="Permanent link">&para;</a></h3>
<p>To see the distribution of cluster waveforms over the probe:</p>
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotClusterWaveformAtCenterOfMass</span><span class="p">()</span>
</pre></div>

<p><img alt="clustermap_com" src="../images/cluster_com.png" title="Cluster center of mass" /></p>
<div class="admonition tip">
<p class="admonition-title">Hover over tool tips</p>
<p>For these plots, in newer versions of Matlab, you can hover over waveforms in the plot to see a popup tooltip that will display information about the cluster to which that waveform belongs.</p>
<p><center>
<img alt="cluster_com_tooltip" src="../images/cluster_com_tooltip.png" title="Cluster center of mass" />
</center></p>
</div>
<h3 id="plotting-electrical-images">Plotting electrical images<a class="headerlink" href="#plotting-electrical-images" title="Permanent link">&para;</a></h3>
<p>You can plot the electrical image of each cluster&rsquo;s templates (or an individual template) as well, using <code class="codehilite">ymag</code> and <code class="codehilite">xmag</code> to zoom in after normalizing.</p>
<div class="codehilite"><pre><span></span><span class="n">cluster_id</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">metrics</span><span class="p">.</span><span class="n">plotClusterImage</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="s">&#39;ymag&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="s">&#39;xmag&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>

<p><img alt="cluster_image" src="../images/cluster_image.png" title="Cluster image" /></p>
<p>Rather than plotting every channel, you can select the best N contiguous channels:
<div class="codehilite"><pre><span></span><span class="n">metrics</span><span class="p">.</span><span class="n">plotClusterImage</span><span class="p">(</span><span class="n">cluster_id</span><span class="p">,</span> <span class="s">&#39;best_n_channels&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
</pre></div></p>
<p><img alt="cluster_image" src="../images/cluster_image_zoom.png" title="Cluster image" /></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../kilosort/" title="Running Kilosort" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Running Kilosort
              </span>
            </div>
          </a>
        
        
          <a href="../waveforms/" title="Extracting Waveforms" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Extracting Waveforms
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2019 &mdash; <a href="http://djoshea.com">Daniel J. O&#39;Shea</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/djoshea" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/djoshea" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.b41f3d20.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-322693-7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-322693-7');
</script>

  </body>
</html>